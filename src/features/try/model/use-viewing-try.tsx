import { useTestTasksQuery } from "@/entities/test/queries";
import { useTryTasksQuery } from "@/entities/try-list";
import { ROUTES } from "@/shared/constants/routes";
import { useRouter } from "next/router";
import { useMemo, useState } from "react";

export function useViewingTry() {
  // ------------------------------------------------------------------
  // –°–û–°–¢–û–Ø–ù–ò–ï
  // ------------------------------------------------------------------
  const [currentTaskIndex, setCurrentTaskIndex] = useState(0);

  const router = useRouter();

  // ------------------------------------------------------------------
  // –û–ë–†–ê–ë–û–¢–ö–ê URL-–ü–ê–†–ê–ú–ï–¢–†–û–í
  // ------------------------------------------------------------------
  const { tryId } = router.query;
  console.log(`–û—Ç–∫—Ä—ã—Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –ø–æ–ø—ã—Ç–∫–∏ —Å id ${tryId}`);

  // ------------------------------------------------------------------
  // üß© –î–ê–ù–ù–´–ï –ó–ê–î–ê–ù–ò–ô (–ó–ê–ì–õ–£–®–ö–ê)
  // ------------------------------------------------------------------

  // tasks –¥–∞–Ω–Ω—ã–µ –∑–∞–≥–ª—É—à–∫–∏
  const tasksTesting = [
    {
      id: 1,
      imageSrcs: ["/test.jpg", "/test.jpg", "/test.jpg", "/test.jpg"],
      pathologyText: `–ö–∞—Ä—Ç–∏–Ω–∫–∞ 1: –ó–æ–Ω–∞ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏ (3–¢) 1–≥–æ —Ç–∏–ø–∞ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏–∑—É–µ—Ç—Å—è –ø–æ–ª–Ω–æ–π –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–µ–π
          –≤—Å–µ–π –ø–ª–æ—â–∞–¥–∏ —Å—Ç—ã–∫–∞ –º–Ω–æ–≥–æ—Å–ª–æ–π–Ω–æ–≥–æ –ø–ª–æ—Å–∫–æ–≥–æ —ç–ø–∏—Ç–µ–ª–∏—è –∏ —Ü–∏–ª–∏–Ω–¥—Ä–∏—á–µ—Å–∫–æ–≥–æ
          —ç–ø–∏—Ç–µ–ª–∏—è, –≤–∫–ª—é—á–∞—è –µ–≥–æ –Ω–∞–∏–±–æ–ª–µ–µ –≤–∞–∂–Ω—ã–π –¥–ª—è —Å–∫—Ä–∏–Ω–∏–Ω–≥–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç ‚Äî
          –≥—Ä–∞–Ω–∏—Ü—É –º–µ—Ç–∞–ø–ª–∞–∑–∏–∏, —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–Ω—É—é –Ω–∞ —ç–∫—Ç–æ—Ü–µ—Ä–≤–∏–∫—Å–µ.`,
      testsQuestions: [
        {
          question: "–ü–ï–ï–†–í–´–ô –ü–¢–ê–õ–ê–ì–û–ò–Ø –ü–µ—Ä–≤–∏—á–Ω—ã–π –æ—Å–º–æ—Ç—Ä",
          typeQuestion: 0,
          instructions: "–í—ã–±–µ—Ä–∏—Ç–µ –æ–¥–∏–Ω –æ—Ç–≤–µ—Ç.",
          answers: [
            "–ö–æ–ª—å–ø–æ—Å–∫–æ–ø–∏—á–µ—Å–∫–∞—è –∫–∞—Ä—Ç–∏–Ω–∞ –∞–¥–µ–∫–≤–∞—Ç–Ω–∞—è ",
            "–ö–æ–ª—å–ø–æ—Å–∫–æ–ø–∏—á–µ—Å–∫–∞—è –∫–∞—Ä—Ç–∏–Ω–∞ –Ω–µ–∞–¥–µ–∫–≤–∞—Ç–Ω–∞—è ",
          ],
        },
        {
          question: "–ì—Ä–∞–Ω–∏—Ü–∞ –º–µ–∂–¥—É –ú–ü–≠ –∏ –¶–≠",
          typeQuestion: 1,
          instructions:
            "–û—Ü–µ–Ω–∏—Ç–µ –≤–∏–¥–∏–º–æ—Å—Ç—å –≥—Ä–∞–Ω–∏—Ü—ã –º–µ–∂–¥—É —ç–ø–∏—Ç–µ–ª–∏—è–º–∏. –í—ã–±–µ—Ä–∏—Ç–µ –æ–¥–∏–Ω –æ—Ç–≤–µ—Ç.",
          answers: [
            "–í–∏–∑—É–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è –ø–æ–ª–Ω–æ—Å—Ç—å—é",
            "–í–∏–∑—É–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è —á–∞—Å—Ç–∏—á–Ω–æ",
            "–ù–µ –≤–∏–∑—É–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è",
          ],
        },
      ],
    },
    {
      id: 2,
      imageSrcs: ["/test.jpg", "/test.jpg", "/test.jpg", "/test.jpg"],
      pathologyText: `–ö–∞—Ä—Ç–∏–Ω–∫–∞ 1: –ó–æ–Ω–∞ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏ (3–¢) 1–≥–æ —Ç–∏–ø–∞ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏–∑—É–µ—Ç—Å—è –ø–æ–ª–Ω–æ–π –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–µ–π
          –≤—Å–µ–π –ø–ª–æ—â–∞–¥–∏ —Å—Ç—ã–∫–∞ –º–Ω–æ–≥–æ—Å–ª–æ–π–Ω–æ–≥–æ –ø–ª–æ—Å–∫–æ–≥–æ —ç–ø–∏—Ç–µ–ª–∏—è –∏ —Ü–∏–ª–∏–Ω–¥—Ä–∏—á–µ—Å–∫–æ–≥–æ
          —ç–ø–∏—Ç–µ–ª–∏—è, –≤–∫–ª—é—á–∞—è –µ–≥–æ –Ω–∞–∏–±–æ–ª–µ–µ –≤–∞–∂–Ω—ã–π –¥–ª—è —Å–∫—Ä–∏–Ω–∏–Ω–≥–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç ‚Äî
          –≥—Ä–∞–Ω–∏—Ü—É –º–µ—Ç–∞–ø–ª–∞–∑–∏–∏, —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–Ω—É—é –Ω–∞ —ç–∫—Ç–æ—Ü–µ—Ä–≤–∏–∫—Å–µ.`,
      testsQuestions: [
        {
          question: "–≠–¢–û –û–¢ –í–¢–û–†–û–ì–û –í–û–ü–†–û–°–ê –ü–µ—Ä–≤–∏—á–Ω—ã–π –æ—Å–º–æ—Ç—Ä",
          typeQuestion: 0,
          instructions: "–í—ã–±–µ—Ä–∏—Ç–µ –æ–¥–∏–Ω –æ—Ç–≤–µ—Ç.",
          answers: [
            "–ö–æ–ª—å–ø–æ—Å–∫–æ–ø–∏—á–µ—Å–∫–∞—è –∫–∞—Ä—Ç–∏–Ω–∞ –∞–¥–µ–∫–≤–∞—Ç–Ω–∞—è ",
            "–ö–æ–ª—å–ø–æ—Å–∫–æ–ø–∏—á–µ—Å–∫–∞—è –∫–∞—Ä—Ç–∏–Ω–∞ –Ω–µ–∞–¥–µ–∫–≤–∞—Ç–Ω–∞—è ",
          ],
        },
        {
          question: "–ì—Ä–∞–Ω–∏—Ü–∞ –º–µ–∂–¥—É –ú–ü–≠ –∏ –¶–≠",
          typeQuestion: 1,
          instructions:
            "–û—Ü–µ–Ω–∏—Ç–µ –≤–∏–¥–∏–º–æ—Å—Ç—å –≥—Ä–∞–Ω–∏—Ü—ã –º–µ–∂–¥—É —ç–ø–∏—Ç–µ–ª–∏—è–º–∏. –í—ã–±–µ—Ä–∏—Ç–µ –æ–¥–∏–Ω –æ—Ç–≤–µ—Ç.",
          answers: [
            "–í–∏–∑—É–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è –ø–æ–ª–Ω–æ—Å—Ç—å—é",
            "–í–∏–∑—É–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è —á–∞—Å—Ç–∏—á–Ω–æ",
            "–ù–µ –≤–∏–∑—É–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è",
          ],
        },
      ],
    },
    {
      id: 3,
      imageSrcs: ["/test.jpg", "/test.jpg", "/test.jpg", "/test.jpg"],
      pathologyText: `–ö–∞—Ä—Ç–∏–Ω–∫–∞ 1: –ó–æ–Ω–∞ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏ (3–¢) 1–≥–æ —Ç–∏–ø–∞ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏–∑—É–µ—Ç—Å—è –ø–æ–ª–Ω–æ–π –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–µ–π
          –≤—Å–µ–π –ø–ª–æ—â–∞–¥–∏ —Å—Ç—ã–∫–∞ –º–Ω–æ–≥–æ—Å–ª–æ–π–Ω–æ–≥–æ –ø–ª–æ—Å–∫–æ–≥–æ —ç–ø–∏—Ç–µ–ª–∏—è –∏ —Ü–∏–ª–∏–Ω–¥—Ä–∏—á–µ—Å–∫–æ–≥–æ
          —ç–ø–∏—Ç–µ–ª–∏—è, –≤–∫–ª—é—á–∞—è –µ–≥–æ –Ω–∞–∏–±–æ–ª–µ–µ –≤–∞–∂–Ω—ã–π –¥–ª—è —Å–∫—Ä–∏–Ω–∏–Ω–≥–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç ‚Äî
          –≥—Ä–∞–Ω–∏—Ü—É –º–µ—Ç–∞–ø–ª–∞–∑–∏–∏, —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–Ω—É—é –Ω–∞ —ç–∫—Ç–æ—Ü–µ—Ä–≤–∏–∫—Å–µ.`,
      testsQuestions: [
        {
          question: "–¢–†–ï–¢–ò–ô –ü–¢–ê–õ–ê–ì–û–ò–Ø –ü–µ—Ä–≤–∏—á–Ω—ã–π –æ—Å–º–æ—Ç—Ä",
          typeQuestion: 0,
          instructions: "–í—ã–±–µ—Ä–∏—Ç–µ –æ–¥–∏–Ω –æ—Ç–≤–µ—Ç.",
          answers: [
            "–ö–æ–ª—å–ø–æ—Å–∫–æ–ø–∏—á–µ—Å–∫–∞—è –∫–∞—Ä—Ç–∏–Ω–∞ –∞–¥–µ–∫–≤–∞—Ç–Ω–∞—è ",
            "–ö–æ–ª—å–ø–æ—Å–∫–æ–ø–∏—á–µ—Å–∫–∞—è –∫–∞—Ä—Ç–∏–Ω–∞ –Ω–µ–∞–¥–µ–∫–≤–∞—Ç–Ω–∞—è ",
          ],
        },
        {
          question: "–ì—Ä–∞–Ω–∏—Ü–∞ –º–µ–∂–¥—É –ú–ü–≠ –∏ –¶–≠",
          typeQuestion: 1,
          instructions:
            "–û—Ü–µ–Ω–∏—Ç–µ –≤–∏–¥–∏–º–æ—Å—Ç—å –≥—Ä–∞–Ω–∏—Ü—ã –º–µ–∂–¥—É —ç–ø–∏—Ç–µ–ª–∏—è–º–∏. –í—ã–±–µ—Ä–∏—Ç–µ –æ–¥–∏–Ω –æ—Ç–≤–µ—Ç.",
          answers: [
            "–í–∏–∑—É–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è –ø–æ–ª–Ω–æ—Å—Ç—å—é",
            "–í–∏–∑—É–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è —á–∞—Å—Ç–∏—á–Ω–æ",
            "–ù–µ –≤–∏–∑—É–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è",
          ],
        },
      ],
    },
    {
      id: 4,
      imageSrcs: ["/test.jpg", "/test.jpg", "/test.jpg", "/test.jpg"],
      pathologyText: `–ö–∞—Ä—Ç–∏–Ω–∫–∞ 1: –ó–æ–Ω–∞ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏ (3–¢) 1–≥–æ —Ç–∏–ø–∞ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏–∑—É–µ—Ç—Å—è –ø–æ–ª–Ω–æ–π –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–µ–π
          –≤—Å–µ–π –ø–ª–æ—â–∞–¥–∏ —Å—Ç—ã–∫–∞ –º–Ω–æ–≥–æ—Å–ª–æ–π–Ω–æ–≥–æ –ø–ª–æ—Å–∫–æ–≥–æ —ç–ø–∏—Ç–µ–ª–∏—è –∏ —Ü–∏–ª–∏–Ω–¥—Ä–∏—á–µ—Å–∫–æ–≥–æ
          —ç–ø–∏—Ç–µ–ª–∏—è, –≤–∫–ª—é—á–∞—è –µ–≥–æ –Ω–∞–∏–±–æ–ª–µ–µ –≤–∞–∂–Ω—ã–π –¥–ª—è —Å–∫—Ä–∏–Ω–∏–Ω–≥–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç ‚Äî
          –≥—Ä–∞–Ω–∏—Ü—É –º–µ—Ç–∞–ø–ª–∞–∑–∏–∏, —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–Ω—É—é –Ω–∞ —ç–∫—Ç–æ—Ü–µ—Ä–≤–∏–∫—Å–µ.`,
      testsQuestions: [
        {
          question: "–≠–¢–û –û–¢ –ß–ï–¢–í–ï–†–¢–û–ì–û –í–û–ü–†–û–°–ê –ü–µ—Ä–≤–∏—á–Ω—ã–π –æ—Å–º–æ—Ç—Ä",
          typeQuestion: 0,
          instructions: "–í—ã–±–µ—Ä–∏—Ç–µ –æ–¥–∏–Ω –æ—Ç–≤–µ—Ç.",
          answers: [
            "–ö–æ–ª—å–ø–æ—Å–∫–æ–ø–∏—á–µ—Å–∫–∞—è –∫–∞—Ä—Ç–∏–Ω–∞ –∞–¥–µ–∫–≤–∞—Ç–Ω–∞—è ",
            "–ö–æ–ª—å–ø–æ—Å–∫–æ–ø–∏—á–µ—Å–∫–∞—è –∫–∞—Ä—Ç–∏–Ω–∞ –Ω–µ–∞–¥–µ–∫–≤–∞—Ç–Ω–∞—è ",
          ],
        },
        {
          question: "–ì—Ä–∞–Ω–∏—Ü–∞ –º–µ–∂–¥—É –ú–ü–≠ –∏ –¶–≠",
          typeQuestion: 1,
          instructions:
            "–û—Ü–µ–Ω–∏—Ç–µ –≤–∏–¥–∏–º–æ—Å—Ç—å –≥—Ä–∞–Ω–∏—Ü—ã –º–µ–∂–¥—É —ç–ø–∏—Ç–µ–ª–∏—è–º–∏. –í—ã–±–µ—Ä–∏—Ç–µ –æ–¥–∏–Ω –æ—Ç–≤–µ—Ç.",
          answers: [
            "–í–∏–∑—É–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è –ø–æ–ª–Ω–æ—Å—Ç—å—é",
            "–í–∏–∑—É–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è —á–∞—Å—Ç–∏—á–Ω–æ",
            "–ù–µ –≤–∏–∑—É–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è",
          ],
        },
      ],
    },
  ];

  // ------------------------------------------------------------------
  // –ó–ê–ü–†–û–° –ö –°–ï–†–í–ï–†–£
  // ------------------------------------------------------------------
  const testTasksQuery = useTestTasksQuery(tryId as string);

  // –î–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –≤—ã–±—Ä–∞–Ω —Ç–µ—Å—Ç–æ–≤—ã–π –Ω–∞–±–æ—Ä –≤–æ–ø—Ä–æ—Å–æ–≤
  // const tasks = testTasksQuery.data?.items ?? [];
  const tasks = tasksTesting;

  const tryAnswersQuery = useTryTasksQuery(tryId as string);
  const tryAnswersData = tryAnswersQuery.data?.tryTasks;

  //–ó–∞–ø–æ–ª–Ω–µ–Ω–æ –∑–∞–≥–ª—É—à–∫–æ–π –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤
  const selectedAnswers: Record<number, Record<number, number[]>> = useMemo(
    () => ({
      1: { 0: [0], 1: [0, 1] },
      2: { 0: [1], 1: [1, 2] },
      3: { 0: [1], 1: [1, 2] },
      4: { 0: [0], 1: [0, 1] },
    }),
    []
  );
  // –†–µ–∞–ª–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ –¥–∞–Ω–Ω—ã–µ —Å —Å–µ—Ä–≤–µ—Ä–∞
  // const selectedAnswers: Record<number, Record<number, number[]>> = useMemo(
  //   () => ({
  //     tryAnswersData
  //   }),
  //   [tryAnswersData]
  // );

  // ------------------------------------------------------------------
  // –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò
  // ------------------------------------------------------------------
  const handleTaskChange = (index: number) => {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≥—Ä–∞–Ω–∏—Ü—ã, –∑–∞—â–∏—â–∞–µ–º—Å—è –æ—Ç undefined
    if (index < 0 || index >= tasks.length) return;
    setCurrentTaskIndex(index);
  };

  const getSelectedFor = (taskId: number, questionIndex: number): number[] =>
    selectedAnswers[taskId]?.[questionIndex] ?? [];

  // ------------------------------------------------------------------
  // üßÆ –°–¢–ê–¢–£–° –ó–ê–ü–û–õ–ù–ï–ù–ò–Ø
  // ------------------------------------------------------------------

  const completionByTask = useMemo(() => {
    return tasks.map((task) => {
      const answersForTask = selectedAnswers[task.id] || {};
      const totalQuestions = task.testsQuestions.length;

      // –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–≤–µ—á–µ–Ω–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ (–≥–¥–µ –µ—Å—Ç—å —Ö–æ—Ç—è –±—ã 1 –≤—ã–±—Ä–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç)
      const answeredCount = Object.values(answersForTask).filter(
        (arr) => arr.length > 0
      ).length;

      return {
        taskId: task.id,
        totalQuestions,
        answeredCount,
        isComplete: answeredCount === totalQuestions,
      };
    });
  }, [selectedAnswers, tasks]);

  return {
    tasks,
    setCurrentTaskIndex,
    isLoading: testTasksQuery.isPending,
    isError: testTasksQuery.isError,
    currentTaskIndex,
    handleTaskChange,
    getSelectedFor,
    completionByTask, // [{ taskId, answeredCount, totalQuestions, isComplete }]
  };
}
