name: CI/CD Pipeline

on:
  push:
    branches: [ main, master ]

jobs:
  # 1. Проверка сборки
  build-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm ci
      # Проверяем билд с той же переменной, что и в проде
      - run: npm run build
        env:
          NEXT_PUBLIC_API_BASE_URL: https://atlascolposcopy.ru/api

  # 2. Автоматический деплой (выполняется только если билд прошел успешно)
  deploy:
    needs: build-check
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}     # IP твоего сервера
          username: ${{ secrets.SERVER_USER }} # root или другой юзер
          key: ${{ secrets.SSH_PRIVATE_KEY }}  # SSH ключ (добавляется в Settings -> Secrets)
          script: |
            cd colposcopy         # Путь к папке с проектом на сервере
            git pull origin master             # Стягиваем новый код
            sudo docker compose up --build -d  # Пересобираем и запускаем